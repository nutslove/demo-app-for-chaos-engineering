apiVersion: 1

groups:
  - orgId: 1
    name: Chaos Scenarios
    folder: Chaos Alerts
    interval: 10s
    rules:
      - uid: high_load_latency
        title: High Load (Latency)
        condition: A
        data:
          - refId: A
            relativeTimeRange:
              from: 60
              to: 0
            datasourceUid: prometheus
            model:
              editorMode: code
              expr: histogram_quantile(0.99, sum(rate(http_server_duration_milliseconds_bucket[1m])) by (le, service_name)) > 1000
              intervalMs: 1000
              maxDataPoints: 43200
              refId: A
        for: 10s
        annotations:
          summary: High Latency Detected
          description: P99 Latency is above 1s for service {{ $labels.service_name }}

      - uid: legacy_product_slowness
        title: Legacy Product Slowness
        condition: A
        data:
          - refId: A
            relativeTimeRange:
              from: 60
              to: 0
            datasourceUid: prometheus
            model:
              editorMode: code
              expr: histogram_quantile(0.99, sum(rate(http_server_duration_milliseconds_bucket{service_name="nodejs-express-service"}[1m])) by (le)) > 1500
              intervalMs: 1000
              maxDataPoints: 43200
              refId: A
        for: 10s
        annotations:
          summary: Legacy Product Slowness
          description: Node.js service is experiencing high latency (> 1.5s)

      - uid: database_timeout
        title: Database Timeout
        condition: A
        data:
          - refId: A
            relativeTimeRange:
              from: 60
              to: 0
            datasourceUid: prometheus
            model:
              editorMode: code
              expr: sum(rate(http_server_requests_seconds_count{service_name="python-fastapi-service", status="504"}[1m])) > 0
              intervalMs: 1000
              maxDataPoints: 43200
              refId: A
        for: 10s
        annotations:
          summary: Database Timeout Detected
          description: Python service is returning 504 Gateway Timeouts

      - uid: fraud_detection
        title: Fraud Detection
        condition: A
        data:
          - refId: A
            relativeTimeRange:
              from: 60
              to: 0
            datasourceUid: prometheus
            model:
              editorMode: code
              # Assuming 403 or specific status for fraud, or just high rate of calls to fraud service that result in rejection
              # Since we don't have a specific metric for "rejected", we'll track 200 OKs from fraud service as a proxy for activity
              # Ideally we'd have a custom metric for fraud_detected
              expr: sum(rate(http_server_requests_seconds_count{service_name="fraud-service"}[1m])) > 0
              intervalMs: 1000
              maxDataPoints: 43200
              refId: A
        for: 10s
        annotations:
          summary: Fraud Check Activity
          description: Fraud service is processing requests

      - uid: payment_failure
        title: Payment Failure
        condition: A
        data:
          - refId: A
            relativeTimeRange:
              from: 60
              to: 0
            datasourceUid: prometheus
            model:
              editorMode: code
              expr: sum(rate(http_server_requests_seconds_count{service_name="payment-service", status!~"200"}[1m])) > 0
              intervalMs: 1000
              maxDataPoints: 43200
              refId: A
        for: 10s
        annotations:
          summary: Payment Failure Detected
          description: Payment service is returning non-200 responses

      - uid: black_friday
        title: Black Friday (Gateway Timeout)
        condition: A
        data:
          - refId: A
            relativeTimeRange:
              from: 60
              to: 0
            datasourceUid: prometheus
            model:
              editorMode: code
              expr: sum(rate(http_server_requests_seconds_count{service_name="payment-service", status="504"}[1m])) > 0
              intervalMs: 1000
              maxDataPoints: 43200
              refId: A
        for: 10s
        annotations:
          summary: Black Friday Gateway Timeout
          description: Payment service is experiencing Gateway Timeouts

      - uid: shipping_failure
        title: Shipping Failure
        condition: A
        data:
          - refId: A
            relativeTimeRange:
              from: 60
              to: 0
            datasourceUid: prometheus
            model:
              editorMode: code
              expr: sum(rate(http_server_requests_seconds_count{service_name="shipping-service", status="500"}[1m])) > 0
              intervalMs: 1000
              maxDataPoints: 43200
              refId: A
        for: 10s
        annotations:
          summary: Shipping Failure Detected
          description: Shipping service is returning 500 Internal Server Errors

      - uid: email_provider_outage
        title: Email Provider Outage
        condition: A
        data:
          - refId: A
            relativeTimeRange:
              from: 60
              to: 0
            datasourceUid: prometheus
            model:
              editorMode: code
              expr: sum(rate(http_server_requests_seconds_count{service_name="java-spring-boot-service", status="500"}[1m])) > 0
              intervalMs: 1000
              maxDataPoints: 43200
              refId: A
        for: 10s
        annotations:
          summary: Email Provider Outage Detected
          description: Java service is returning 500 Internal Server Errors
